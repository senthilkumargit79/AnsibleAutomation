
---
- name: Check stack port status on device(s)
  hosts: all
  gather_facts: no
  collections:
    - cisco.ios

  tasks:
    - name: Run 'show switch detail' on device
      ios_command:
        commands:
          - "{{ stack_show_command }}"
      register: stack_out

    - name: Extract switch states from command output
      set_fact:
        switch_states: "{{ stack_out.stdout[0] | regex_findall(state_capture_regex) | map('lower') | list }}"
        switches_total: "{{ (stack_out.stdout[0] | regex_findall(state_capture_regex)) | length }}"
        switches_ready: "{{ (stack_out.stdout[0] | regex_findall(ready_token)) | length }}"
        switches_down:  "{{ (stack_out.stdout[0] | regex_findall(down_token))  | length }}"
        all_ready: "{{ switches_total > 0 and switches_ready == switches_total }}"
        any_down: "{{ switches_down | int > 0 }}"

    - name: Show parsed summary
      debug:
        msg:
          device: "{{ inventory_hostname }}"
          switches_total: "{{ switches_total }}"
          ready: "{{ switches_ready }}"
          down: "{{ switches_down }}"
          all_ready: "{{ all_ready }}"
          any_down: "{{ any_down }}"

    # Optionally fail the play if any switch is down (useful for CI/CD integration)
    - name: Fail if any switch is DOWN
      fail:
        msg: "One or more switches are DOWN on {{ inventory_hostname }}."
      when: any_down | bool
      ignore_errors: true
